<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Password Cracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card main-card">
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <i class="fas fa-file-pdf pdf-icon"></i>
                            <h1 class="card-title">PDF Password Cracker</h1>
                            <p class="text-muted">Unlock password-protected PDFs using name-based patterns</p>
                        </div>

                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else 'info' }} alert-dismissible fade show" role="alert">
                                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm" style="display: block;">
                            <div class="mb-4">
                                <label for="first_name" class="form-label">
                                    <i class="fas fa-user me-2"></i>First Name
                                </label>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="first_name" 
                                       name="first_name" 
                                       placeholder="Enter your first name"
                                       required
                                       maxlength="20"
                                       pattern="[A-Za-z]+"
                                       title="Please enter only letters">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Passwords will be generated using the first 4 letters + years 1900-2025
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="pdf_file" class="form-label">
                                    <i class="fas fa-upload me-2"></i>PDF File
                                </label>
                                <input type="file" 
                                       class="form-control form-control-lg" 
                                       id="pdf_file" 
                                       name="pdf_file" 
                                       accept=".pdf"
                                       required>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Select a password-protected PDF file (max 16MB)
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg pulse-btn" id="submitBtn">
                                    <i class="fas fa-key me-2"></i>Start Cracking
                                    <span class="btn-glow"></span>
                                </button>
                            </div>
                        </form>

                        <!-- Progress Section (hidden initially) -->
                        <div id="progressSection" class="progress-section" style="display: none;">
                            <div class="text-center mb-4">
                                <i class="fas fa-cog fa-spin progress-icon" id="statusIcon"></i>
                                <h3 class="progress-title" id="statusMessage">Testing passwords...</h3>
                            </div>

                            <!-- Progress Bar -->
                            <div class="progress-container mb-4">
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         id="progressBar"
                                         style="width: 0%">
                                        <span id="progressText">0%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Status -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="info-card">
                                        <h6><i class="fas fa-key me-2"></i>Current Password</h6>
                                        <div class="current-password" id="currentPassword">Starting...</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-card">
                                        <h6><i class="fas fa-chart-line me-2"></i>Progress</h6>
                                        <div class="progress-info">
                                            <span id="currentCount">0</span> / <span id="totalCount">126</span> passwords tested
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Result Section -->
                            <div id="resultSection" class="result-section" style="display: none;">
                                <div id="successResult" class="alert alert-success" style="display: none;">
                                    <h5><i class="fas fa-check-circle me-2"></i>Password Found!</h5>
                                    <p class="mb-2">The correct password is:</p>
                                    <div class="password-result" id="foundPassword"></div>
                                </div>

                                <div id="errorResult" class="alert alert-danger" style="display: none;">
                                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                                    <p id="errorMessage"></p>
                                </div>

                                <div id="failedResult" class="alert alert-warning" style="display: none;">
                                    <h5><i class="fas fa-times-circle me-2"></i>Password Not Found</h5>
                                    <p>Password not found, please try with another first name.</p>
                                </div>
                            </div>

                            <!-- Action Button -->
                            <div class="d-grid">
                                <button type="button" class="btn btn-secondary" id="tryAgainBtn" style="display: none;" onclick="resetForm()">
                                    <i class="fas fa-redo me-2"></i>Try Again
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Single page progress tracking
        let progressInterval;
        let isCompleted = false;
        let sessionId = null;
        let timeoutTimer = null;

        // Handle form submission without redirect
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return false;
            }

            // Show progress section
            document.getElementById('uploadForm').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            
            // Submit form via fetch
            const formData = new FormData(this);
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionId = data.session_id;
                    startProgressTracking();
                } else {
                    showError(data.error || 'Upload failed');
                }
            })
            .catch(error => {
                showError('Network error occurred');
            });
        });

        // Start progress tracking
        function startProgressTracking() {
            progressInterval = setInterval(updateProgress, 500); // Update every 0.5 seconds for faster updates
            updateProgress();
            
            // Set 30 second timeout as backup
            timeoutTimer = setTimeout(() => {
                if (!isCompleted) {
                    console.log('30 second timeout reached, forcing completion');
                    isCompleted = true;
                    clearInterval(progressInterval);
                    
                    // Force show try again with timeout message
                    const data = {
                        status: 'failed',
                        error: 'Process timed out - please try again',
                        total_passwords: 126,
                        progress: 126
                    };
                    handleCompletion(data);
                }
            }, 30000); // 30 seconds
        }

        // Update progress from server
        function updateProgress() {
            if (!sessionId || isCompleted) return;
            
            fetch('/api/progress/' + sessionId)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Don't show error if already completed
                        if (!isCompleted) {
                            console.log('Session ended');
                        }
                        return;
                    }

                    // Update progress bar
                    const progressPercent = Math.round((data.progress / data.total_passwords) * 100);
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    
                    progressBar.style.width = progressPercent + '%';
                    progressText.textContent = progressPercent + '%';

                    // Update current password
                    document.getElementById('currentPassword').textContent = data.current_password || 'Initializing...';
                    
                    // Update counters
                    document.getElementById('currentCount').textContent = data.progress;
                    document.getElementById('totalCount').textContent = data.total_passwords;

                    // Handle completion
                    if (data.completed && !isCompleted) {
                        isCompleted = true;
                        clearInterval(progressInterval);
                        if (timeoutTimer) clearTimeout(timeoutTimer);
                        handleCompletion(data);
                    } else if ((data.status === 'failed' || data.status === 'success' || data.status === 'error') && !isCompleted) {
                        // Fallback completion detection
                        isCompleted = true;
                        clearInterval(progressInterval);
                        if (timeoutTimer) clearTimeout(timeoutTimer);
                        handleCompletion(data);
                    }
                })
                .catch(error => {
                    // Don't show error if already completed
                    if (!isCompleted) {
                        console.log('Network error during progress update');
                    }
                });
        }

        // Handle completion
        function handleCompletion(data) {
            console.log('handleCompletion called with:', data); // Debug log
            
            const statusIcon = document.getElementById('statusIcon');
            const statusMessage = document.getElementById('statusMessage');
            const resultSection = document.getElementById('resultSection');
            const tryAgainBtn = document.getElementById('tryAgainBtn');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            // Stop the spinning animation
            statusIcon.classList.remove('fa-spin');

            // Ensure progress reaches 100% on completion
            progressBar.style.width = '100%';
            progressText.textContent = '100%';
            document.getElementById('currentCount').textContent = data.total_passwords || 126;

            // Show result and try again button
            resultSection.style.display = 'block';
            tryAgainBtn.style.display = 'block';

            if (data.status === 'success' && data.found_password) {
                statusIcon.className = 'fas fa-check-circle success-icon';
                statusMessage.textContent = 'Password found successfully!';
                
                document.getElementById('successResult').style.display = 'block';
                document.getElementById('foundPassword').textContent = data.found_password;
                
                progressBar.className = 'progress-bar bg-success';
                progressText.textContent = 'Success!';
                
            } else if (data.status === 'failed') {
                statusIcon.className = 'fas fa-times-circle error-icon';
                statusMessage.textContent = 'Password not found';
                
                document.getElementById('failedResult').style.display = 'block';
                
                progressBar.className = 'progress-bar bg-warning';
                progressText.textContent = 'Complete - No Match';
                
            } else if (data.status === 'error') {
                statusIcon.className = 'fas fa-exclamation-triangle error-icon';
                statusMessage.textContent = 'An error occurred';
                
                document.getElementById('errorResult').style.display = 'block';
                document.getElementById('errorMessage').textContent = data.error || 'Unknown error occurred';
                
                progressBar.className = 'progress-bar bg-danger';
                progressText.textContent = 'Error';
            }
        }

        // Show error
        function showError(message) {
            const statusIcon = document.getElementById('statusIcon');
            const statusMessage = document.getElementById('statusMessage');
            
            statusIcon.className = 'fas fa-exclamation-triangle error-icon';
            statusMessage.textContent = message;
            
            document.getElementById('tryAgainBtn').style.display = 'block';
            clearInterval(progressInterval);
        }

        // Reset form
        function resetForm() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('uploadForm').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('uploadForm').reset();
            sessionId = null;
            isCompleted = false;
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            if (timeoutTimer) {
                clearTimeout(timeoutTimer);
            }
        }
    </script>
    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <div class="footer-section">
                        <h6><i class="fas fa-chart-line me-2"></i>Live Stats</h6>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-number" id="totalCracks">1,247</span>
                                <span class="stat-label">PDFs Cracked</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="successRate">78%</span>
                                <span class="stat-label">Success Rate</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="footer-section">
                        <h6><i class="fas fa-phone me-2"></i>Contact</h6>
                        <div class="contact-info">
                            <a href="https://wa.me/912269718563" class="whatsapp-btn" target="_blank">
                                <i class="fab fa-whatsapp me-2"></i>For Any Panel, APK, UPI Mod Contact WhatsApp
                                <span class="phone-number">+91 22 6971 8563</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer-bottom mt-4">
                <p>&copy; 2025 PDF Password Cracker. All rights reserved.</p>
            </div>
        </div>
    </footer>

</body>
</html>
